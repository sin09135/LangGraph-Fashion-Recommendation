import json
import re
from src.database.postgresql_manager import PostgreSQLManager
from src.utils.data_processor import MusinsaDataProcessor

def extract_product_id_from_url(url):
    """URLÏóêÏÑú product_id Ï∂îÏ∂ú"""
    match = re.search(r'/products/(\d+)', url)
    return match.group(1) if match else None

def create_improved_tables(pg_manager):
    """Í∞úÏÑ†Îêú ÌÖåÏù¥Î∏î Íµ¨Ï°∞ ÏÉùÏÑ±"""
    with pg_manager.get_connection() as conn:
        with conn.cursor() as cursor:
            # Í∏∞Ï°¥ ÌÖåÏù¥Î∏î ÏÇ≠Ï†ú (Ïû¨ÏÉùÏÑ±)
            cursor.execute("DROP TABLE IF EXISTS sizes CASCADE")
            cursor.execute("DROP TABLE IF EXISTS reviews CASCADE")
            cursor.execute("DROP TABLE IF EXISTS style_keywords CASCADE")
            cursor.execute("DROP TABLE IF EXISTS products CASCADE")
            
            # ÏÉÅÌíà ÌÖåÏù¥Î∏î (Í∞úÏÑ†Îêú Íµ¨Ï°∞)
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS products (
                    product_id VARCHAR(50) PRIMARY KEY,
                    product_name TEXT NOT NULL,
                    category VARCHAR(100),
                    sub_category VARCHAR(100),
                    brand VARCHAR(100),
                    price INTEGER,
                    rating DECIMAL(3,2) DEFAULT 0.00,
                    review_count INTEGER DEFAULT 0,
                    url TEXT,
                    image_url TEXT,
                    tags TEXT[],
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            """)
            
            # ÏÇ¨Ïù¥Ï¶à ÌÖåÏù¥Î∏î (ÏÉàÎ°ú Ï∂îÍ∞Ä)
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS sizes (
                    id SERIAL PRIMARY KEY,
                    product_id VARCHAR(50) REFERENCES products(product_id) ON DELETE CASCADE,
                    size_label VARCHAR(20) NOT NULL,
                    total_length DECIMAL(5,2),
                    chest_width DECIMAL(5,2),
                    shoulder_width DECIMAL(5,2),
                    UNIQUE(product_id, size_label)
                )
            """)
            
            # Î¶¨Î∑∞ ÌÖåÏù¥Î∏î (Í∞úÏÑ†Îêú Íµ¨Ï°∞)
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS reviews (
                    id SERIAL PRIMARY KEY,
                    product_id VARCHAR(50) REFERENCES products(product_id) ON DELETE CASCADE,
                    review_index INTEGER,
                    content TEXT,
                    rating DECIMAL(3,2),
                    likes INTEGER DEFAULT 0,
                    comments INTEGER DEFAULT 0,
                    user_name VARCHAR(100),
                    review_date VARCHAR(20),
                    purchase_info TEXT,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(product_id, review_index)
                )
            """)
            
            # Ïä§ÌÉÄÏùº ÌÇ§ÏõåÎìú ÌÖåÏù¥Î∏î
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS style_keywords (
                    id SERIAL PRIMARY KEY,
                    product_id VARCHAR(50) REFERENCES products(product_id) ON DELETE CASCADE,
                    keyword VARCHAR(100) NOT NULL,
                    weight DECIMAL(3,2) DEFAULT 1.00,
                    UNIQUE(product_id, keyword)
                )
            """)
            
            # Ïù∏Îç±Ïä§ ÏÉùÏÑ±
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_products_category ON products(category)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_products_brand ON products(brand)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_products_price ON products(price)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_products_rating ON products(rating)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_sizes_product_id ON sizes(product_id)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_reviews_product_id ON reviews(product_id)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_style_keywords_keyword ON style_keywords(keyword)")
            
            # ÌíÄÌÖçÏä§Ìä∏ Í≤ÄÏÉâ Ïù∏Îç±Ïä§
            cursor.execute("""
                CREATE INDEX IF NOT EXISTS idx_products_name_search 
                ON products USING gin(to_tsvector('english', product_name))
            """)
            
            cursor.execute("""
                CREATE INDEX IF NOT EXISTS idx_reviews_content_search 
                ON reviews USING gin(to_tsvector('english', content))
            """)
            
            conn.commit()
            print("‚úÖ Í∞úÏÑ†Îêú ÌÖåÏù¥Î∏î Íµ¨Ï°∞ ÏÉùÏÑ± ÏôÑÎ£å")

def load_and_insert_merged_data(pg_manager):
    """merged_all_data.jsonÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è ÏÇΩÏûÖ"""
    print("üìä merged_all_data.json Î°úÎìú Ï§ë...")
    
    with open('data/merged_all_data.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    print(f"‚úÖ {len(data)}Í∞ú ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å")
    
    with pg_manager.get_connection() as conn:
        with conn.cursor() as cursor:
            products_inserted = 0
            sizes_inserted = 0
            reviews_inserted = 0
            tags_inserted = 0
            
            for item in data:
                # 1. product_id Ï∂îÏ∂ú
                product_id = extract_product_id_from_url(item.get('url', ''))
                if not product_id:
                    continue
                
                # 2. ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
                product_name = item.get('product_name', '')
                categories = item.get('categories', [])
                category = categories[0] if categories else ''
                sub_category = categories[1] if len(categories) > 1 else ''
                
                # Î∏åÎûúÎìú Ï∂îÏ∂ú (product_nameÏóêÏÑú [Î∏åÎûúÎìúÎ™Ö] ÌòïÌÉúÎ°ú Ï∂îÏ∂ú)
                brand_match = re.search(r'\[([^\]]+)\]', product_name)
                brand = brand_match.group(1) if brand_match else ''
                
                # ÌÉúÍ∑∏ Ï≤òÎ¶¨
                tags = item.get('tags', [])
                tags_array = [tag.replace('#', '') for tag in tags] if tags else []
                
                # Î¶¨Î∑∞ Ï†ïÎ≥¥
                review_info = item.get('review_info', {})
                rating = float(review_info.get('rating', 0)) if review_info.get('rating') else 0.0
                review_count = int(review_info.get('count', 0)) if review_info.get('count') else 0
                
                cursor.execute("""
                    INSERT INTO products 
                    (product_id, product_name, category, sub_category, brand, 
                     rating, review_count, url, tags)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                    ON CONFLICT (product_id) DO UPDATE SET
                        product_name = EXCLUDED.product_name,
                        category = EXCLUDED.category,
                        sub_category = EXCLUDED.sub_category,
                        brand = EXCLUDED.brand,
                        rating = EXCLUDED.rating,
                        review_count = EXCLUDED.review_count,
                        url = EXCLUDED.url,
                        tags = EXCLUDED.tags,
                        updated_at = CURRENT_TIMESTAMP
                """, (
                    product_id, product_name, category, sub_category, brand,
                    rating, review_count, item.get('url', ''), tags_array
                ))
                products_inserted += 1
                
                # 3. ÏÇ¨Ïù¥Ï¶à Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
                size_info = item.get('size_info', {})
                if size_info and 'headers' in size_info and 'rows' in size_info:
                    headers = size_info['headers']
                    rows = size_info['rows']
                    
                    for i, row in enumerate(rows):
                        if len(row) > 0 and row[0] != "ÏÇ¨Ïù¥Ï¶àÎ•º ÏßÅÏ†ë ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî":
                            size_label = f"ÏÇ¨Ïù¥Ï¶à_{i+1}"
                            total_length = float(row[0]) if len(row) > 0 and row[0].replace('.', '').isdigit() else None
                            chest_width = float(row[1]) if len(row) > 1 and row[1].replace('.', '').isdigit() else None
                            shoulder_width = float(row[2]) if len(row) > 2 and row[2].replace('.', '').isdigit() else None
                            
                            cursor.execute("""
                                INSERT INTO sizes 
                                (product_id, size_label, total_length, chest_width, shoulder_width)
                                VALUES (%s, %s, %s, %s, %s)
                                ON CONFLICT (product_id, size_label) DO UPDATE SET
                                    total_length = EXCLUDED.total_length,
                                    chest_width = EXCLUDED.chest_width,
                                    shoulder_width = EXCLUDED.shoulder_width
                            """, (product_id, size_label, total_length, chest_width, shoulder_width))
                            sizes_inserted += 1
                
                # 4. Î¶¨Î∑∞ Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
                reviews = review_info.get('reviews', [])
                for review in reviews:
                    cursor.execute("""
                        INSERT INTO reviews 
                        (product_id, review_index, content, rating, likes, comments, 
                         user_name, review_date, purchase_info)
                        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                        ON CONFLICT (product_id, review_index) DO UPDATE SET
                            content = EXCLUDED.content,
                            rating = EXCLUDED.rating,
                            likes = EXCLUDED.likes,
                            comments = EXCLUDED.comments,
                            user_name = EXCLUDED.user_name,
                            review_date = EXCLUDED.review_date,
                            purchase_info = EXCLUDED.purchase_info
                    """, (
                        product_id,
                        review.get('index', 0),
                        review.get('content', ''),
                        float(review.get('rating', 0)) if review.get('rating') else None,
                        review.get('likes', 0),
                        review.get('comments', 0),
                        review.get('user', ''),
                        review.get('date', ''),
                        review.get('purchase_info', '')
                    ))
                    reviews_inserted += 1
                
                # 5. ÌÉúÍ∑∏Î•º Ïä§ÌÉÄÏùº ÌÇ§ÏõåÎìúÎ°ú ÏÇΩÏûÖ
                for tag in tags_array:
                    cursor.execute("""
                        INSERT INTO style_keywords (product_id, keyword)
                        VALUES (%s, %s)
                        ON CONFLICT (product_id, keyword) DO NOTHING
                    """, (product_id, tag))
                    tags_inserted += 1
            
            conn.commit()
            
            print(f"‚úÖ Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ ÏôÑÎ£å:")
            print(f"  - ÏÉÅÌíà: {products_inserted}Í∞ú")
            print(f"  - ÏÇ¨Ïù¥Ï¶à: {sizes_inserted}Í∞ú")
            print(f"  - Î¶¨Î∑∞: {reviews_inserted}Í∞ú")
            print(f"  - Ïä§ÌÉÄÏùº ÌÇ§ÏõåÎìú: {tags_inserted}Í∞ú")

def main():
    """Í∞úÏÑ†Îêú PostgreSQL Ï¥àÍ∏∞Ìôî Î∞è Îç∞Ïù¥ÌÑ∞ Ï†ÅÏû¨"""
    print("=== Í∞úÏÑ†Îêú PostgreSQL Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî ÏãúÏûë ===")
    
    # PostgreSQL Îß§ÎãàÏ†Ä Ï¥àÍ∏∞Ìôî
    pg_manager = PostgreSQLManager(
        host="localhost",
        port=5432,
        database="fashion_recommendation",
        user="postgres",
        password="password"
    )
    
    # 1. Í∞úÏÑ†Îêú ÌÖåÏù¥Î∏î Íµ¨Ï°∞ ÏÉùÏÑ±
    create_improved_tables(pg_manager)
    
    # 2. merged_all_data.jsonÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è ÏÇΩÏûÖ
    load_and_insert_merged_data(pg_manager)
    
    # 3. ÌÜµÍ≥Ñ Ï†ïÎ≥¥ Ï∂úÎ†•
    print("\n=== Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÜµÍ≥Ñ ===")
    stats = pg_manager.get_statistics()
    print(f"Ï¥ù ÏÉÅÌíà Ïàò: {stats.get('total_products', 0)}")
    print(f"Ï¥ù Î¶¨Î∑∞ Ïàò: {stats.get('total_reviews', 0)}")
    print(f"Ï¥ù Ïä§ÌÉÄÏùº ÌÇ§ÏõåÎìú Ïàò: {stats.get('total_style_keywords', 0)}")
    
    print("\nüéâ Í∞úÏÑ†Îêú PostgreSQL Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!")

if __name__ == "__main__":
    main() 