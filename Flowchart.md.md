flowchart TD
    %% 사용자 입력
    A["🟡 사용자 발화"] --> B["🔍 의도 분석 (Intent Detection)"]

    %% Intent 분기
    B -->|추천 관련 의도| C1["🔵 추천 에이전트 전환"]
    B -->|일상대화| C2["🟢 일상대화 에이전트"]

    %% 일상대화 → 유도 분기
    C2 --> D2["맥락 기반 추천 유도 판단"]
    D2 -->|유도 타이밍| E2["유도 질문 발화: ‘추천해드릴까요?’"]
    E2 --> F2["사용자 응답"]
    F2 -->|긍정| C1
    F2 -->|부정| C2

    %% 추천 에이전트 시작
    C1 --> G["🎯 추천 Intent/슬롯 추출"]

    %% 추천 방식 분기
    G -->|조건 명확| H1["🟨 SQL 기반 추천"]
    G -->|유사 의미 요청| H2["🟦 Vector DB 기반 추천"]
    G -->|사용자 기반| H3["🟩 ML 개인화 추천"]

    %% 추천 결과 제공
    H1 --> I["🔽 추천 결과 제시"]
    H2 --> I
    H3 --> I

    %% 사용자 피드백 감지
    I --> J["🗣 사용자 피드백 감지"]

    %% 피드백 유형에 따른 분기
    J -->|긍정 평가| K1["✅ 추천 종료 or 관련 추천 강화"]
    J -->|조건 변경 요청| K2["🛠 슬롯 변경 후 재추천 → G"]
    J -->|부정 평가| K3["🚫 재추천: 제외 / 쿼리 조정 → G"]
    J -->|더 보고 싶음| K4["🔁 다양성 확대 재추천 → G"]
    J -->|행동 기반(클릭, 구매)| K5["📦 피드백 로그 기록 + 개인화 강화"]

    %% 종료 조건
    K1 --> L["🏁 대화 종료 or 구매 유도"]
    K2 --> I
    K3 --> I
    K4 --> I
    K5 --> I
